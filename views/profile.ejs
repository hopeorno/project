<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profile - AlUla</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; font-family:Arial,sans-serif; }
    body { background: linear-gradient(135deg,#1a1a1a 0%,#2d2d2d 100%); min-height:100vh; color:#fff; }

    .profile-container { max-width:900px; margin:50px auto; background:rgba(44,44,44,0.95); border-radius:15px; overflow:hidden; box-shadow:0 8px 32px rgba(0,0,0,0.3); }
    .profile-header { background: linear-gradient(135deg,#d4af37 0%,#b8941f 100%); padding:40px; text-align:center; color:#1a1a1a; }
    .profile-avatar { width:100px; height:100px; border-radius:50%; background:#1a1a1a; display:flex; align-items:center; justify-content:center; font-size:40px; margin:0 auto 20px; border:4px solid #fff; }
    .profile-header h2 { font-size:28px; margin-bottom:5px; }
    .profile-header p { font-size:14px; opacity:0.8; }

    .tabs { display:flex; background:rgba(26,26,26,0.8); border-bottom:1px solid rgba(212,175,55,0.3); }
    .tab { flex:1; padding:20px; text-align:center; cursor:pointer; border:none; background:transparent; color:#ccc; font-size:16px; transition:all 0.3s; position:relative; }
    .tab:hover { color:#d4af37; background:rgba(212,175,55,0.1); }
    .tab.active { color:#d4af37; background:rgba(212,175,55,0.15); }
    .tab.active::after { content:''; position:absolute; bottom:0; left:0; right:0; height:3px; background:#d4af37; }

    .tab-content { display:none; padding:40px; animation:fadeIn 0.3s; }
    .tab-content.active { display:block; }
    @keyframes fadeIn { from {opacity:0; transform:translateY(10px);} to {opacity:1; transform:translateY(0);} }

    .info-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:20px; margin-bottom:30px; }
    .info-card { background:rgba(26,26,26,0.5); padding:20px; border-radius:10px; border:1px solid rgba(212,175,55,0.2); }
    .info-card label { display:block; color:#d4af37; font-size:12px; text-transform:uppercase; margin-bottom:10px; letter-spacing:1px; }
    .info-card p { font-size:16px; color:#fff; }

    .form-group { margin-bottom:25px; }
    .form-group label { display:block; color:#d4af37; font-size:12px; text-transform:uppercase; margin-bottom:10px; letter-spacing:1px; }
    .form-group input { width:100%; padding:12px; background: rgba(26,26,26,0.5); border:1px solid rgba(212,175,55,0.3); border-radius:5px; color:#fff; font-size:14px; transition:border-color 0.3s; }
    .form-group input:focus { outline:none; border-color:#d4af37; }

    .btn { padding:12px 30px; background:#d4af37; color:#1a1a1a; border:none; border-radius:5px; cursor:pointer; font-size:14px; font-weight:bold; transition: all 0.3s; }
    .btn:hover { background:#b8941f; transform:translateY(-2px); box-shadow:0 4px 12px rgba(212,175,55,0.3); }

    .message { padding:12px; border-radius:5px; margin-bottom:20px; display:none; }
    .message.success { background: rgba(76,175,80,0.2); border:1px solid #4caf50; color:#4caf50; }
    .message.error { background: rgba(244,67,54,0.2); border:1px solid #f44336; color:#f44336; }

    .event-card { background:rgba(26,26,26,0.5); padding:20px; border-radius:10px; margin-bottom:15px; border-left:4px solid #d4af37; display:flex; justify-content:space-between; align-items:center; }
    .event-card h4 { color:#d4af37; margin-bottom:10px; }
    .event-card p { color:#ccc; font-size:14px; margin:5px 0; }
    .event-card .event-icon { font-size:40px; opacity:0.5; }
    .empty-state { text-align:center; padding:60px 20px; color:#999; }
    .loading { text-align:center; padding:40px; color:#d4af37; }
    .status-badge { display:inline-block; padding:4px 12px; border-radius:12px; font-size:12px; font-weight:bold; }
    .status-pending { background:rgba(255,152,0,0.2); color:#ff9800; }
    .status-confirmed { background:rgba(76,175,80,0.2); color:#4caf50; }
    /* CONTACT SECTION */
.contact-section {
  padding: 60px;
  background-color: #1a1a1a;
  text-align: center;
}

.contact-section h2 {
  color: #ffffff;
  margin-bottom: 20px;
}

.contact-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 30px;
  margin-top: 40px;
}

.contact-box {
  background-color: #2c2c2c;
  padding: 30px;
  border-radius: 10px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}

.contact-box h3 {
  color: #d4af37;
  margin-bottom: 15px;
}

.contact-box p {
  color: #ccc;
  line-height: 1.6;
}
  </style>
</head>
<body>

<div class="profile-container">

  <div class="profile-header">
    <div class="profile-avatar"><%= user.firstName.charAt(0).toUpperCase()+user.lastName.charAt(0).toUpperCase() %></div>
    <h2><%= user.firstName %> <%= user.lastName %></h2>
    <p><%= user.email %></p>
  </div>

  <div class="tabs">
    <button class="tab active" onclick="openTab('info')">My Information</button>
    <button class="tab" onclick="openTab('settings')">Settings</button>
    <button class="tab" onclick="openTab('favorites')">My Favorites ‚ù§Ô∏è</button>
    <button class="tab" onclick="openTab('bookings')">My Bookings üìÖ</button>
  </div>

  <!-- My Info -->
  <div id="info" class="tab-content active">
    <h3 style="color:#d4af37; margin-bottom:30px;">Personal Information</h3>
    <div class="info-grid">
      <div class="info-card"><label>First Name</label><p><%= user.firstName %></p></div>
      <div class="info-card"><label>Last Name</label><p><%= user.lastName %></p></div>
      <div class="info-card"><label>Email</label><p><%= user.email %></p></div>
    </div>
  </div>

  <!-- Settings -->
  <div id="settings" class="tab-content">
    <h3 style="color:#d4af37; margin-bottom:30px;">Account Settings</h3>
    <div id="updateMessage" class="message"></div>
    <form id="updateForm">
      <div class="form-group"><label>First Name</label><input type="text" name="firstName" value="<%= user.firstName %>" required></div>
      <div class="form-group"><label>Last Name</label><input type="text" name="lastName" value="<%= user.lastName %>" required></div>
      <h4 style="color:#d4af37; margin:30px 0 20px;">Change Password</h4>
      <div class="form-group"><label>Current Password</label><input type="password" name="currentPassword" placeholder="Leave empty if not changing"></div>
      <div class="form-group"><label>New Password</label><input type="password" name="newPassword" placeholder="Enter new password"></div>
      <button type="submit" class="btn">Save Changes</button>
    </form>
  </div>

  <!-- Favorites -->
  <div id="favorites" class="tab-content">
    <h3 style="color:#d4af37; margin-bottom:20px;">My Favorite Events ‚ù§Ô∏è</h3>
    <div id="favoritesLoading" class="loading">Loading your favorites...</div>
    <div id="favoritesList"></div>
  </div>

  <!-- Bookings -->
  <div id="bookings" class="tab-content">
    <h3 style="color:#d4af37; margin-bottom:30px;">My Bookings</h3>
    <div id="bookingsLoading" class="loading">Loading your bookings...</div>
    <div id="bookingsList"></div>
    <div style="text-align:center; margin-top:30px;"><a href="/booking" class="btn">Book New Tour</a></div>
  </div>

</div>

<script>
// ============================================
// ÿßÿ≥ÿ™ÿ®ÿØŸÑ ÿ¨ÿ≤ÿ° ÿßŸÑŸÄ JavaScript ŸÅŸä profile.ejs ÿ®Ÿáÿ∞ÿß ÿßŸÑŸÉŸàÿØ
// ============================================

// ÿØŸàÿßŸÑ ŸÅÿ™ÿ≠ ÿßŸÑÿ™ÿßÿ®ÿßÿ™
function openTab(tabName) {
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById(tabName).classList.add('active');
  event.target.classList.add('active');

  // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿπŸÜÿØ ŸÅÿ™ÿ≠ ÿßŸÑÿ™ÿßÿ®
  if (tabName === 'favorites') loadFavorites();
  if (tabName === 'bookings') loadBookings();
}

// ============================================
// ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ÿ±ŸàŸÅÿßŸäŸÑ
// ============================================
document.getElementById('updateForm').addEventListener('submit', async e => {
  e.preventDefault();
  const formData = new FormData(e.target);
  const data = Object.fromEntries(formData);
  const messageDiv = document.getElementById('updateMessage');
  
  try {
    const res = await fetch('/profile/update', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    
    const result = await res.json();
    messageDiv.style.display = 'block';
    
    if (result.success) {
      messageDiv.className = 'message success';
      messageDiv.textContent = result.message;
      
      // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿßÿ≥ŸÖ ŸÅŸä ÿßŸÑŸáŸäÿØÿ±
      document.querySelector('.profile-header h2').textContent = data.firstName + ' ' + data.lastName;
      document.querySelector('.profile-avatar').textContent = 
        data.firstName.charAt(0).toUpperCase() + data.lastName.charAt(0).toUpperCase();
      
      // ŸÖÿ≥ÿ≠ ÿ≠ŸÇŸàŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±
      e.target.querySelector('[name="currentPassword"]').value = '';
      e.target.querySelector('[name="newPassword"]').value = '';
    } else {
      messageDiv.className = 'message error';
      messageDiv.textContent = result.message;
    }
    
    setTimeout(() => { messageDiv.style.display = 'none'; }, 5000);
  } catch (err) {
    messageDiv.style.display = 'block';
    messageDiv.className = 'message error';
    messageDiv.textContent = 'Error updating profile';
  }
});

// ============================================
// ÿ¨ŸÑÿ® ÿßŸÑŸÖŸÅÿ∂ŸÑÿßÿ™
// ============================================
async function loadFavorites() {
  const loading = document.getElementById('favoritesLoading');
  const list = document.getElementById('favoritesList');
  
  loading.style.display = 'block';
  list.innerHTML = '';
  
  try {
    const res = await fetch('/api/my-likes');
    const data = await res.json();
    
    loading.style.display = 'none';
    
    if (data.success && data.favorites && data.favorites.length > 0) {
      data.favorites.forEach(fav => {
        const card = document.createElement('div');
        card.className = 'event-card';
        card.innerHTML = `
          <div style="flex: 1;">
            <h4>${fav.event_name}</h4>
            <p><strong>Date:</strong> ${fav.event_date || 'TBA'}</p>
            <p><strong>Location:</strong> ${fav.event_location || 'AlUla'}</p>
            <p style="font-size: 12px; color: #999; margin-top: 10px;">
              Liked on: ${new Date(fav.liked_at).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
              })}
            </p>
          </div>
          <div class="event-icon">‚ù§Ô∏è</div>
        `;
        list.appendChild(card);
      });
    } else {
      list.innerHTML = `
        <div class="empty-state">
          <div style="font-size: 60px; margin-bottom: 20px;">üíî</div>
          <h3 style="color: #999;">No favorites yet</h3>
          <p>Start exploring and like events!</p>
          <a href="/tours" class="btn" style="margin-top: 20px; display: inline-block; text-decoration: none;">
            Browse Events
          </a>
        </div>
      `;
    }
  } catch (err) {
    console.error('Load favorites error:', err);
    loading.style.display = 'none';
    list.innerHTML = `
      <div class="empty-state">
        <p style="color: #f44336;">Error loading favorites</p>
      </div>
    `;
  }
}

// ============================================
// ÿ¨ŸÑÿ® ÿßŸÑÿ≠ÿ¨Ÿàÿ≤ÿßÿ™
// ============================================
async function loadBookings() {
  const loading = document.getElementById('bookingsLoading');
  const list = document.getElementById('bookingsList');
  
  loading.style.display = 'block';
  list.innerHTML = '';
  
  try {
    const res = await fetch('/api/my-bookings');
    const data = await res.json();
    
    loading.style.display = 'none';
    
    if (data.success && data.bookings && data.bookings.length > 0) {
      data.bookings.forEach(booking => {
        const card = document.createElement('div');
        card.className = 'event-card';
        
        const statusClass = booking.booking_status.toLowerCase();
        
        card.innerHTML = `
          <div style="flex: 1;">
            <h4>${booking.activity_name}</h4>
            <p><strong>Date:</strong> ${booking.booking_date}</p>
            <p><strong>Guests:</strong> ${booking.num_people} ${booking.num_people > 1 ? 'People' : 'Person'}</p>
            <p><strong>Status:</strong> 
              <span class="status-badge status-${statusClass}">
                ${booking.booking_status}
              </span>
            </p>
            <p style="font-size: 12px; color: #999; margin-top: 10px;">
              Booked on: ${new Date(booking.created_at).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
              })}
            </p>
          </div>
          <div class="event-icon">üìÖ</div>
        `;
        list.appendChild(card);
      });
    } else {
      list.innerHTML = `
        <div class="empty-state">
          <div style="font-size: 60px; margin-bottom: 20px;">üìÖ</div>
          <h3 style="color: #999;">No bookings yet</h3>
          <p>Book your first tour!</p>
          <a href="/tours" class="btn" style="margin-top: 20px; display: inline-block; text-decoration: none;">
            Browse Tours
          </a>
        </div>
      `;
    }
  } catch (err) {
    console.error('Load bookings error:', err);
    loading.style.display = 'none';
    list.innerHTML = `
      <div class="empty-state">
        <p style="color: #f44336;">Error loading bookings</p>
      </div>
    `;
  }
}

// ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑÿ™ÿßÿ® ŸÖŸÅÿ™Ÿàÿ≠
window.addEventListener('DOMContentLoaded', () => {
  if (document.getElementById('favorites').classList.contains('active')) {
    loadFavorites();
  }
  if (document.getElementById('bookings').classList.contains('active')) {
    loadBookings();
  }
});
</script>
<!-- CONTACT SECTION -->
<div class="contact-section">
  <h2>Need an expert? Leave your info and we‚Äôll be in touch shortly</h2>
  <div class="contact-grid">
    <div class="contact-box">
      <h3>VISIT US</h3>
      <p>Come and visit us at our office and we‚Äôll help you with all your needs.<br><br> Alula, Saudi Arabia</p>
    </div>
    <div class="contact-box">
      <h3>CALL US</h3>
      <p>Feel free to give us a call, we are here to help you.<br><br>+966 55 555 555</p>
    </div>
    <div class="contact-box">
      <h3>CONTACT US</h3>
      <p>You can also contact us via email or our contact form.<br><br>alula@sa.com</p>
    </div>
  </div>
</div>
</body>
</html>